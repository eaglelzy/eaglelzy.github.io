<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Lizy&#39;s Wiki">
<meta property="og:url" content="http://eaglelzy.github.io/page/2/index.html">
<meta property="og:site_name" content="Lizy&#39;s Wiki">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lizy&#39;s Wiki">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":15,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://eaglelzy.github.io/page/2/">





  <title>Lizy's Wiki</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lizy's Wiki</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eaglelzy.github.io/2018/05/13/赶集RN项目快速上手/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lizy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lizy's Wiki">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/13/赶集RN项目快速上手/" itemprop="url">赶集RN项目快速上手</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-13T17:17:45+08:00">
                2018-05-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/13/赶集RN项目快速上手/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/05/13/赶集RN项目快速上手/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2 id="RN简介"><a href="#RN简介" class="headerlink" title="RN简介"></a>RN简介</h2><h3 id="什么是RN"><a href="#什么是RN" class="headerlink" title="什么是RN"></a>什么是RN</h3><ul>
<li>React Native(RN) 是Facebook在2015推出的基于JavaScrip的开源框架。</li>
<li>使用JavaScrip开发Android和IOS原生应用。具有Web开发效率和原生的性能体验。</li>
<li>learn once, write everywhere</li>
</ul>
<h3 id="RN通信原理"><a href="#RN通信原理" class="headerlink" title="RN通信原理"></a>RN通信原理</h3><p><img src="/assets/images/rn_通信原理_1.png" alt=""><br><img src="/assets/images/rn_通信原理.png" alt=""><br><a href="https://blog.csdn.net/MegatronKings/article/details/51114278" target="_blank" rel="noopener">更多Native和JS通信原理</a></p>
<h2 id="创建一个RN项目"><a href="#创建一个RN项目" class="headerlink" title="创建一个RN项目"></a>创建一个RN项目</h2><h3 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h3><p>运行rn需要Node， RN命令行工具以及JDK和Android Studio。</p>
<h4 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pacman -S nodejs npm</span><br></pre></td></tr></table></figure>
<p>更多平台安装请参考 <a href="https://nodejs.org/en/download/package-manager/" target="_blank" rel="noopener">Node安装</a></p>
<h4 id="The-React-Native-CLI"><a href="#The-React-Native-CLI" class="headerlink" title="The React Native CLI"></a>The React Native CLI</h4><p>React Native的命令行工具用于执行创建、初始化、更新项目、运行打包服务（packager）等任务。<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g react-native-cli</span><br></pre></td></tr></table></figure></p>
<h4 id="JDK以及Android-Studio"><a href="#JDK以及Android-Studio" class="headerlink" title="JDK以及Android Studio"></a>JDK以及Android Studio</h4><p>…</p>
<h4 id="Watchman-推荐"><a href="#Watchman-推荐" class="headerlink" title="Watchman(推荐)"></a>Watchman(推荐)</h4><p>Watchman是facebook开发的一款可以用来监视文件系统改变的工具，安装后可以提升性能。<a href="https://facebook.github.io/watchman/docs/install.html" target="_blank" rel="noopener">watchman安装</a></p>
<h4 id="Yarn-推荐"><a href="#Yarn-推荐" class="headerlink" title="Yarn(推荐)"></a>Yarn(推荐)</h4><p>有时在执行npm install时会很慢，可以安装Yarn。Yarn是Facebook提供的替代npm的工具，可以加速node模块的下载。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g yarn</span><br></pre></td></tr></table></figure>
<p>安装完成后设置镜像源：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn config set registry https://registry.npm.taobao.org --global</span><br><span class="line">yarn config set disturl https://npm.taobao.org/dist --global</span><br></pre></td></tr></table></figure></p>
<h3 id="创建一个RN应用"><a href="#创建一个RN应用" class="headerlink" title="创建一个RN应用"></a>创建一个RN应用</h3><p>使用RN命令行接口可以初始化一个RN应用:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native init HelloReactNative</span><br></pre></td></tr></table></figure></p>
<p>执行成功后会创建一个HelloReactNative目录, 目录结构如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">├── android</span><br><span class="line">├── App.js</span><br><span class="line">├── app.json</span><br><span class="line">├── index.js</span><br><span class="line">├── ios</span><br><span class="line">├── node_modules</span><br><span class="line">├── package.json</span><br><span class="line">└── yarn.lock</span><br></pre></td></tr></table></figure></p>
<p>进入HelloReactNative目录, 执行以下命令运行app:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd HelloReactNative</span><br><span class="line">react-native run-android</span><br></pre></td></tr></table></figure></p>
<h2 id="RN基础知识"><a href="#RN基础知识" class="headerlink" title="RN基础知识"></a>RN基础知识</h2><h3 id="props"><a href="#props" class="headerlink" title="props"></a>props</h3><p>大多数组件在创建时就可以使用各种参数来进行定制。用于定制的这些参数就称为props（属性）<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Bananas</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">let</span> pic = &#123;</span><br><span class="line">      uri: <span class="string">'https://upload.wikimedia.org/wikipedia/commons/d/de/Bananavarieties.jpg'</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Image source=&#123;pic&#125; style=&#123;&#123;<span class="attr">width</span>: <span class="number">193</span>, <span class="attr">height</span>: <span class="number">110</span>&#125;&#125;/&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>自定义的组件也可以使用props。通过在不同的场景使用不同的属性定制，可以尽量提高自定义组件的复用范畴。只需在render函数中引用this.props，然后按需处理即可。下面是一个例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeting</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Text&gt;Hello &#123;<span class="keyword">this</span>.props.name&#125;!&lt;/Text&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">LotsOfGreetings</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;View style=&#123;&#123;<span class="attr">alignItems</span>: <span class="string">'center'</span>&#125;&#125;&gt;</span><br><span class="line">        &lt;Greeting name=<span class="string">'Rexxar'</span> /&gt;</span><br><span class="line">        &lt;Greeting name=<span class="string">'Jaina'</span> /&gt;</span><br><span class="line">        &lt;Greeting name=<span class="string">'Valeera'</span> /&gt;</span><br><span class="line">      &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="state"><a href="#state" class="headerlink" title="state"></a>state</h3><p><code>props</code>是在父组件中指定，而且一经指定，在被指定的组件的生命周期中则不再改变。 对于需要改变的数据，我们需要使用<code>state</code>。 一般来说，我们需要在constructor中初始化<code>state</code>，然后在需要修改时调用<code>setState</code>方法。以一个模拟网络请求为例:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">NetDemo</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.state = &#123;</span><br><span class="line">            loading: <span class="literal">true</span>,</span><br><span class="line">            code: <span class="number">-1</span>,</span><br><span class="line">            msg: <span class="string">""</span>,</span><br><span class="line">            data: &#123;</span><br><span class="line">                moves: []</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    componentDidMount() &#123;</span><br><span class="line">        setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.setState(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;</span><br><span class="line">                    loading: <span class="literal">false</span>,</span><br><span class="line">                    code: <span class="number">0</span>,</span><br><span class="line">                    msg: <span class="string">"success"</span>,</span><br><span class="line">                    data: &#123;</span><br><span class="line">                        movies: [</span><br><span class="line">                            &#123; <span class="attr">title</span>: <span class="string">"头号玩家"</span>, <span class="attr">time</span>: <span class="string">"2018-4-1"</span> &#125;,</span><br><span class="line">                            &#123; <span class="attr">title</span>: <span class="string">"极限特工"</span>, <span class="attr">time</span>: <span class="string">"2018-5-1"</span> &#125;,</span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    renderLoading() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">                &lt;ActivityIndicator /&gt;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    renderSuccess() &#123;</span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">            &lt;View style=&#123;styles.itemContainer&#125;&gt;</span></span><br><span class="line"><span class="regexp">                &lt;FlatList</span></span><br><span class="line"><span class="regexp">                    data=&#123;this.state.data.movies&#125;</span></span><br><span class="line"><span class="regexp">                  renderItem=&#123;(&#123; item &#125;) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">                        return &lt;View style=&#123;styles.item&#125;&gt;</span></span><br><span class="line"><span class="regexp">                            &lt;Text style=&#123;styles.welcome&#125;&gt;标题: &#123;item.title&#125;&lt;/</span>Text&gt;</span><br><span class="line">                            &lt;Text style=&#123;styles.welcome&#125;&gt;上映时间: &#123;item.time&#125;&lt;<span class="regexp">/Text&gt;</span></span><br><span class="line"><span class="regexp">                        &lt;/</span>View&gt;</span><br><span class="line">                    &#125;&#125;</span><br><span class="line">                /&gt;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    renderError() &#123;</span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">            &lt;View style=&#123;styles.container&#125;&gt;</span></span><br><span class="line"><span class="regexp">            &lt;Text&gt;Error&lt;/</span>Text&gt;</span><br><span class="line">            &lt;<span class="regexp">/View&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    render() &#123;</span></span><br><span class="line"><span class="regexp">        if (this.state.loading) &#123;</span></span><br><span class="line"><span class="regexp">            return this.renderLoading();</span></span><br><span class="line"><span class="regexp">        &#125; else if (this.state.code == 0) &#123;</span></span><br><span class="line"><span class="regexp">            return this.renderSuccess();</span></span><br><span class="line"><span class="regexp">        &#125; else &#123;</span></span><br><span class="line"><span class="regexp">            return this.renderError();</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="扩展RN"><a href="#扩展RN" class="headerlink" title="扩展RN"></a>扩展RN</h3><p>RN内置了常用的组件(Text, Image, Button…)和Api(Alert, NetInfo, ToastAndroid…), 可以满足大部分需求场景, 但有时我们需要使用Native现有的一些功能, 比如登录, 比如扩展图片库, 此时可以通过自定义Module或View来实现.<br>比如要使用Native的登录模块, 则可以先在Native端定义一个LoginModule.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginModule</span> <span class="keyword">extends</span> <span class="title">ReactContextBaseJavaModule</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"LoginModule"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ReactMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(String username, String password, Promise promise)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            WritableMap map = Arguments.createMap();</span><br><span class="line">            map.putInt(<span class="string">"code"</span>, <span class="number">0</span>);</span><br><span class="line">            map.putString(<span class="string">"msg"</span>, <span class="string">"success"</span>);</span><br><span class="line">            WritableMap dataMap = Arguments.createMap();</span><br><span class="line">            dataMap.putString(<span class="string">"token"</span>, <span class="string">"0ladsflk0p23840928347"</span>);</span><br><span class="line">            dataMap.putString(<span class="string">"uid"</span>, <span class="string">"120384234"</span>);</span><br><span class="line">            map.putMap(<span class="string">"data"</span>, dataMap);</span><br><span class="line">            promise.resolve(map);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            promise.reject(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>定义完成后要加到一个Package里面<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GanjiPackages</span> <span class="keyword">implements</span> <span class="title">ReactPackage</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;NativeModule&gt; <span class="title">createNativeModules</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</span><br><span class="line">        List&lt;NativeModule&gt; list = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> LoginModule(reactContext));</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ViewManager&gt; <span class="title">createViewManagers</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>之后要在ReactNativeHost添加Package信息:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;ReactPackage&gt; <span class="title">getPackages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> Arrays.&lt;ReactPackage&gt;asList(</span><br><span class="line">          <span class="keyword">new</span> MainReactPackage(),</span><br><span class="line">              <span class="keyword">new</span> GanjiPackages()</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>然后就可以在JS端调用了:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NativeModules.LoginModule.login(<span class="string">"lizy"</span>, <span class="string">"lizy"</span>)</span><br><span class="line">    .then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">        alert(<span class="string">"登录成功: token="</span> + result.data.token);</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">        alert(<span class="string">"登录失败: error="</span> + result.msg);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<h2 id="赶集客户端集成RN"><a href="#赶集客户端集成RN" class="headerlink" title="赶集客户端集成RN"></a>赶集客户端集成RN</h2><p>赶集客户端目前是以Lib形式集成RN的, 方便以后组件化. 在Lib工程下集成了node环境, 所以运行时需要在Lib工程下运行一下<code>npm install</code>. 目前使用的RN版本是0.53.3, 引入RN时需要在原有工程做两个修改:</p>
<ol>
<li>minsdk要改成16, RN支持的最小版本即为16</li>
<li>由于RN编译后只有armeabi-v7和x86架构,考虑到x86手机数量较少, 所以只保留armeabi-v7. 项目中也要保留armeabi-v7</li>
</ol>
<h3 id="统一载体页"><a href="#统一载体页" class="headerlink" title="统一载体页"></a>统一载体页</h3><p>所谓载体页实际上是RN的一个容器, 这个容器可以是一个Activity,一个Fragment甚至是一个View, RN本身有一个ReactRootView是一个FrameLayout的子类, 载体页只需要将这个View加入并关联一个ReactContext即可. 之所以统一载体页是因为载体页除了作为RN的容器之外还应该承载一些其他功能, 比如: 路由跳转, 热更新等. 目前赶集RN的载体页是WBReactFragment类, 建议以后也统一使用该载体页.</p>
<h3 id="自定义图片控件"><a href="#自定义图片控件" class="headerlink" title="自定义图片控件"></a>自定义图片控件</h3><p>RN默认的图片控件在Native的默认实现是Fresco, 而我们工程使用的是Glide. 如果同一个工程使用了两个图片库的话,内存会造成非常大的浪费, 而且目前RN的Image控件不支持占位图. 所以重新自定义了一套Image控件. 具体可以参考Ship工程ImageView.android.js以及Native模块的GlideImageView.java部分代码.</p>
<h3 id="集成网络库"><a href="#集成网络库" class="headerlink" title="集成网络库"></a>集成网络库</h3><p>RN的网络请求使用的是fetch, 底层的实现是OkHttp, 默认会创建一个新的OkHttpClient, 看源码fetch的Native实现Module为NetworkingModule.java. 里面有一个OkHttpClientProvider, 该类提供了一个创建OkHttpClient的工厂类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OkHttpClientProvider.setOkHttpClientFactory(() -&gt; &#123;</span><br><span class="line">    OkHttpClient.Builder builder = OkHttpSingleton.getInstance().getOkHttpClient().newBuilder();</span><br><span class="line">    builder.cookieJar(<span class="keyword">new</span> ReactCookieJarContainer());</span><br><span class="line">    builder.addInterceptor(<span class="keyword">new</span> LogInterceptor());</span><br><span class="line">    <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>通过该方法, 我们把fetch创建的默认OkHttpClient对象替换成了我们自己的OkHttpClient, 这样网络请求就可以复用链接等一些共用资源了, 提升了网络性能</p>
<h3 id="统一跳转中心"><a href="#统一跳转中心" class="headerlink" title="统一跳转中心"></a>统一跳转中心</h3><p>为了实现RN和Native之间能够任意跳转, 需要引入一套路由协议, JS端可以通过以下两个方法打开Native界面<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">async openPageForResult(target, params = &#123;&#125;) &#123;</span><br><span class="line">    if(target)&#123;</span><br><span class="line">        let result = await NativeModules.RouterModule.openPageForResult(target, params);</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">openPage(target, params = &#123;&#125;) &#123;</span><br><span class="line">    if(target)&#123;</span><br><span class="line">        NativeModules.RouterModule.openPage(target, params);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Native需要实现相应的Module, 目前项目中引入了ARouter支持的跳转协议.</p>
<h3 id="信息中心"><a href="#信息中心" class="headerlink" title="信息中心"></a>信息中心</h3><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>[ ] 热更新实现方案<br>[ ] 多个bundle的加载以及拆包优化<br>[x] 使用Redux<br>[ ] 懒加载<br>[ ] 异常处理</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://github.com/facebook/react-native" target="_blank" rel="noopener">react native github</a><br><a href="https://facebook.github.io/react-native/" target="_blank" rel="noopener">React Native官方英文文档</a><br><a href="https://reactnative.cn/" target="_blank" rel="noopener">React Native官方中文文档</a><br><a href="https://github.com/reactnativecn/react-native-guide" target="_blank" rel="noopener">RN学习资料汇总</a><br><a href="https://blog.csdn.net/MegatronKings/article/details/51114278" target="_blank" rel="noopener">Native与Javascript通信原理1</a><br><a href="https://blog.csdn.net/Megatronkings/article/details/51138499" target="_blank" rel="noopener">Native与Javascript通信原理2</a></p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>android 项目svn地址: <a href="http://svn.58corp.com/Mobile/Android/GanJilife/TestBranches/V8.8.0-GanjiLife-RNtest" target="_blank" rel="noopener">http://svn.58corp.com/Mobile/Android/GanJilife/TestBranches/V8.8.0-GanjiLife-RNtest</a><br>JS工程地址: <a href="http://gitlab.58corp.com/hrg-ydzp-mobile/Ship" target="_blank" rel="noopener">http://gitlab.58corp.com/hrg-ydzp-mobile/Ship</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eaglelzy.github.io/2018/04/16/react_native/Image组件调研/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lizy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lizy's Wiki">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/16/react_native/Image组件调研/" itemprop="url">Image组件在Android上的使用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-04-16T10:18:01+08:00">
                2018-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/ReactNative/" itemprop="url" rel="index">
                    <span itemprop="name">ReactNative</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/04/16/react_native/Image组件调研/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/04/16/react_native/Image组件调研/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用介绍"><a href="#使用介绍" class="headerlink" title="使用介绍"></a>使用介绍</h2><p>rn 的图片组件是Image, 使用Image可以加载js图片,native图片和网络图片资源:</p>
<h3 id="加载js图片资源"><a href="#加载js图片资源" class="headerlink" title="加载js图片资源"></a>加载js图片资源</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── button.js</span><br><span class="line">└── img</span><br><span class="line">    ├── check@<span class="number">2</span>x.png</span><br><span class="line">    └── check@<span class="number">3</span>x.png</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Image source=&#123;<span class="built_in">require</span>(<span class="string">'./img/check.png'</span>)&#125; /&gt;</span><br></pre></td></tr></table></figure>
<h3 id="加载native资源"><a href="#加载native资源" class="headerlink" title="加载native资源"></a>加载native资源</h3><p>Image组件可以加载android本地,包括assets, mipmap, drawable以及sdcard上的图片资源:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mipmap</span></span><br><span class="line">&lt;Image source=&#123;&#123; <span class="attr">uri</span>: <span class="string">'mipmap/ic_launcher'</span> &#125;&#125; /&gt;</span><br><span class="line"><span class="comment">// drawable</span></span><br><span class="line">&lt;Image source=&#123;&#123; <span class="attr">uri</span>: <span class="string">'ic_launcher'</span> &#125;&#125; /&gt;</span><br><span class="line"><span class="comment">// asset</span></span><br><span class="line">&lt;Image source=&#123;&#123; <span class="attr">uri</span>: <span class="string">'asset:/ic_launcher.png'</span> &#125;&#125; /&gt;</span><br><span class="line"><span class="comment">// sdcard</span></span><br><span class="line">&lt;Image source=&#123;&#123; <span class="attr">uri</span>: <span class="string">'file:/sdcard/ic_launcher.png'</span> &#125;&#125; /&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="加载网络图片资源"><a href="#加载网络图片资源" class="headerlink" title="加载网络图片资源"></a>加载网络图片资源</h3><p>Image加载网络图片方式<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Image source=&#123;&#123;<span class="attr">uri</span>: <span class="string">'https://facebook.github.io/react/img/logo_og.png'</span>&#125;&#125;</span><br><span class="line">       style=&#123;&#123;<span class="attr">width</span>: <span class="number">400</span>, <span class="attr">height</span>: <span class="number">400</span>&#125;&#125; /&gt;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://reactnative.cn/docs/0.45/images.html" target="_blank" rel="noopener">更多使用方式</a></p>
<h2 id="重点"><a href="#重点" class="headerlink" title="重点"></a>重点</h2><p>Image组件android端底层使用的是fresco图片库, 功能还是很强大的, 几乎能满足所有的需求场景了.<br>有个问题是赶集客户端使用的图片库glide, 共用两套图片库的话在内存上肯定会造成不必要的浪费, 内存上会存在性能问题.</p>
<h2 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h2><h3 id="defaultSource标签Android不生效"><a href="#defaultSource标签Android不生效" class="headerlink" title="defaultSource标签Android不生效"></a>defaultSource标签Android不生效</h3><p>Image有个defaultSource标签, 该标签是用来设置占位图的, 目前只在IOS上生效, 而在Android是不生效的.  有几种解决方案:</p>
<ol>
<li>在js端封装一下,通过绝对布局来实现占位图(可能会消耗不必要的内存)</li>
<li>等最新版本发布, 看master分支源码是已经支持了的(什么时候发布还不确定)</li>
<li>自定义native图片库替换掉fresco库(一劳永逸)</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://facebook.github.io/react-native/docs/images.html" target="_blank" rel="noopener">https://facebook.github.io/react-native/docs/images.html</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eaglelzy.github.io/2018/03/27/du调研报告/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lizy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lizy's Wiki">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/27/du调研报告/" itemprop="url">du调研报告</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-27T00:00:00+08:00">
                2018-03-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/27/du调研报告/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/03/27/du调研报告/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2 id="du简介"><a href="#du简介" class="headerlink" title="du简介"></a>du简介</h2><p>du(Dynamic Update)是一款招才猫团队自研的, 基于JavaScript语言的, 支持android客户端动态化的技术解决方案, 用于构建原生App体验的开发框架. du有以下特点:</p>
<ol>
<li>无需发版, 动态下发业务逻辑</li>
<li>原生的用户体验</li>
<li>自研发</li>
<li>面向Android开发者</li>
</ol>
<h2 id="DU的工作原理"><a href="#DU的工作原理" class="headerlink" title="DU的工作原理"></a>DU的工作原理</h2><p><img src="/assets/images/du/du_work.png" alt=""></p>
<h2 id="DU框架结构"><a href="#DU框架结构" class="headerlink" title="DU框架结构"></a>DU框架结构</h2><p><img src="/assets/images/du/du_arch.png" alt=""></p>
<h2 id="DU性能分析"><a href="#DU性能分析" class="headerlink" title="DU性能分析"></a>DU性能分析</h2><ol>
<li>UI组件每次API调用比原生要多附加10ms</li>
<li>200条列表数据加载比原生慢150ms</li>
<li>大数据量网络请求比原生慢100ms</li>
<li>其他与原生交互性能差别不大</li>
</ol>
<p>复杂页面加载速度比Native略慢<br>简单页面基本与Native实现速度一致.<br>进行过内存压力测试, 加载100万条JS语句, 内存可以及时回收, 无内存泄露问题, 无内存溢出现象</p>
<p>du和Native页面性能对比:<br><img src="/asserts/images/du/du_xingneng.png" alt=""></p>
<h2 id="接入成本"><a href="#接入成本" class="headerlink" title="接入成本"></a>接入成本</h2><p>接入du主要要做3方面工作:</p>
<ol>
<li><p>二次开发,<br>主要是组件扩展, 扩展模块接入, 数据转换模块接入. 比如网络, 定位, 日志, 埋点等基础模块的开发.<br>在前期这是主要的工作. 扩展组件越丰富, 开发效率就越高. </p>
</li>
<li><p>混淆问题<br>目前du是不支持混淆的, 还要招才猫团队提供混淆规则</p>
</li>
<li><p>更新方案<br>目前du框架的更新模块跟sdk是一起的, 需要等招才猫团队把更新模块剥离出来, 并且要搭建统一的版本管理平台. </p>
</li>
</ol>
<h2 id="与RN比较"><a href="#与RN比较" class="headerlink" title="与RN比较"></a>与RN比较</h2><h3 id="跨平台"><a href="#跨平台" class="headerlink" title="跨平台"></a>跨平台</h3><p>rn支持Android,IOS和web多个平台, 可以复用大部分代码<br>du只支持Android, 对于android开发比较友好</p>
<h3 id="学习成本"><a href="#学习成本" class="headerlink" title="学习成本"></a>学习成本</h3><p>rn有许多依赖配置工具, 对于Android开发者学习成本相对较高.<br>du只支持Android, 而且布局跟原生基本一致, 对于android开发者学习成本较小.</p>
<h3 id="开发调试"><a href="#开发调试" class="headerlink" title="开发调试"></a>开发调试</h3><p>都支持使用Android Studio和js编辑器开发<br>都可以在chrome中调试js代码</p>
<h3 id="扩展性"><a href="#扩展性" class="headerlink" title="扩展性"></a>扩展性</h3><p>du和rn都支持组件的扩展, rn第三方库比较全</p>
<h3 id="依赖引擎"><a href="#依赖引擎" class="headerlink" title="依赖引擎"></a>依赖引擎</h3><p>du依赖V8引擎, rn依赖JSCore</p>
<h3 id="性能"><a href="#性能" class="headerlink" title="性能"></a>性能</h3><p>对于不复杂的界面, du和rn都可以达到接近原生的性能</p>
<h3 id="社区文档支持"><a href="#社区文档支持" class="headerlink" title="社区文档支持"></a>社区文档支持</h3><p>rn有成熟的社区和详细的文档, facebook, google, QQ, 百度, 京东等都有使用<br>du由于是自研, 目前只有招才猫使用. 文档还需完善</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>rn在跨平台上有很大优势, 同时支持IOS,Android和web, 可以节省人力. 原来3端的人力, 使用rn可能只需要1.5个人就可以完成.<br>du目前只支持Android平台, 对于android开发者比较友好. </li>
<li>rn有成熟的社区和完善的文档, 而且有大量优秀项目已经在应用, 已经非常成熟. du则是我们自研, 目前只有招才猫在使用, 文档还需要完善</li>
<li>对于android来说接入du的成本比较小, 但是从长远来看考虑到rn的跨平台性, 接入rn的成本会更小一些. </li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eaglelzy.github.io/2018/03/02/android/内存优化总结/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lizy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lizy's Wiki">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/02/android/内存优化总结/" itemprop="url">内存优化总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-02T10:42:00+08:00">
                2018-03-02
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/02/android/内存优化总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/03/02/android/内存优化总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>8.6.0版本针对OOM做了一些处理, 从4个方面进行了优化. 现总结如下:</p>
<h2 id="图片的占位图"><a href="#图片的占位图" class="headerlink" title="图片的占位图"></a>图片的占位图</h2><h3 id="ImageManager-showImage的不合理使用"><a href="#ImageManager-showImage的不合理使用" class="headerlink" title="ImageManager.showImage的不合理使用"></a>ImageManager.showImage的不合理使用</h3><p>项目中有大量类似以下代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Bitmap holder = BitmapFactory.decodeResource(getResources(), R.drawable.post_list_place_holder);</span><br><span class="line">Bitmap fail = BitmapFactory.decodeResource(getResources(), R.drawable.post_list_place_holder);</span><br><span class="line">ImageManager.showImage(view, url, holder, fail);</span><br></pre></td></tr></table></figure></p>
<p>每个占位图都会创建一个新的bitmap, 尤其是一些列表页这样会消耗很多不必要的内存, 尽量避免类似代码, 而应该采用如下形式:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImageManager.showImage(view, url, R.drawable.post_list_place_holder, R.drawable.post_list_place_holder);</span><br></pre></td></tr></table></figure></p>
<p>这样写相同的占位图会复用一个bitmap, 从而节省内存</p>
<h3 id="针对大的占位图"><a href="#针对大的占位图" class="headerlink" title="针对大的占位图"></a>针对大的占位图</h3><p>项目中有一些比较大的占位图, 比如首页广告轮播图, 房产顶部图片浏览占位图, 这些占位图分辨率都很高占的内存很大, 而且有很多不同尺寸的占位图存在. 对于这些非常大的占位图, 专门定义了一个layer-list作为background, 而把大的占位图删掉<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;layer-list</span><br><span class="line">    xmlns:android=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span><br><span class="line">    &lt;item&gt;</span><br><span class="line">        &lt;shape android:shape=<span class="string">"rectangle"</span>&gt;</span><br><span class="line">            &lt;solid android:color=<span class="string">"#f3f3f3"</span>/&gt;</span><br><span class="line">        &lt;/shape&gt;</span><br><span class="line">    &lt;/item&gt;</span><br><span class="line">    &lt;item android:bottom=<span class="string">"40dp"</span>&gt;</span><br><span class="line">        &lt;bitmap</span><br><span class="line">            android:gravity=<span class="string">"center_horizontal|bottom"</span></span><br><span class="line">            android:src=<span class="string">"@drawable/default_ganji_icon"</span>/&gt;</span><br><span class="line">    &lt;/item&gt;</span><br><span class="line">&lt;/layer-list&gt;</span><br></pre></td></tr></table></figure></p>
<p>这样虽然多了一层背景设置, 但是该背景占用内存很小, 而且多个场景还可以复用一个背景, 也会省去很多内存</p>
<h2 id="针对不透明的大图片使用glide加载"><a href="#针对不透明的大图片使用glide加载" class="headerlink" title="针对不透明的大图片使用glide加载"></a>针对不透明的大图片使用glide加载</h2><p>项目中有一些不透明的大图是直接在布局设置的背景或src(比如用户中心顶部背景图), 这样加载出来的图片是ARBG_8888格式的, 可以使用如下代码调用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImageManager.showImage(<span class="meta">@NonNull</span> ImageView imageView, <span class="meta">@NonNull</span> Integer resourceId, <span class="meta">@Nullable</span> Transformation transformation);</span><br></pre></td></tr></table></figure></p>
<p>这样加载的图片格式为RBG_565, 内存可以减少到原来的一半</p>
<h2 id="工友圈图片流加载模式设置为atMost"><a href="#工友圈图片流加载模式设置为atMost" class="headerlink" title="工友圈图片流加载模式设置为atMost"></a>工友圈图片流加载模式设置为atMost</h2><p>通过android studio查看工友圈瀑布流图片所占内存发现有很多尺寸相对较大图片占了比较大的内存, glide在加载图片时默认采用压缩方式为AT_LEAST, 会把图片压缩到1倍和2倍之间, 可以把压缩方式改为AT_MOST, 这样图片会压缩到1/2到1之间, 从而节省一半内存, 而图片实际看起来也没有太大的失真</p>
<h2 id="针对容易发生OOM的机型执行小内存分配策略"><a href="#针对容易发生OOM的机型执行小内存分配策略" class="headerlink" title="针对容易发生OOM的机型执行小内存分配策略"></a>针对容易发生OOM的机型执行小内存分配策略</h2><p>从bugly上可以看到有一些机型很容易发生OOM, 比如小米4, 三星GT-N7100等, 针对这些机型在分配图片缓存时适当降低内存分配大小也可以减少OOM概率. </p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eaglelzy.github.io/2017/10/11/android/Ndk开发/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lizy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lizy's Wiki">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/11/android/Ndk开发/" itemprop="url">Ndk开发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T14:45:45+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">android</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/10/11/android/Ndk开发/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/10/11/android/Ndk开发/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>NDK(Native Development Kit)是一系列工具，使用这些工具可以使Android调用C和C++代码。<br>对于大部分Android应用一般不会使用到NDK，NDK特别适合以下情况：</p>
<ul>
<li>对于性能要求比较高的场景，比如：游戏和视频相机等</li>
<li>复用现有的c和c++库</li>
<li>安全性</li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="下载NDK和工具"><a href="#下载NDK和工具" class="headerlink" title="下载NDK和工具"></a>下载NDK和工具</h3><p><img src="/asserts/images/ndk_download_tools.png" alt=""></p>
<ul>
<li>NDK</li>
<li>CMake 是一个可以使用Gradle帮助构建native库的扩展工具。也可以不下载, 只用ndk-build</li>
<li>LLDB 是Android Studio调试本地代码的调试器</li>
</ul>
<h3 id="创建Native工程"><a href="#创建Native工程" class="headerlink" title="创建Native工程"></a>创建Native工程</h3><p>Android Studio 2.2或更高版本对natvie的支持已经相当好了。创建工程时就可以选择是否支持native。<br><img src="/asserts/images/ndk_create_new_project.png" alt=""></p>
<p>创建完成后跟普通Android工程主要有4个不同<br><img src="/asserts/images/ndk_project.png" alt=""></p>
<h3 id="构建工程"><a href="#构建工程" class="headerlink" title="构建工程"></a>构建工程</h3><p>有两种构建方式，ndk-build和cmake, 这两种方式跟Android代码和c/c++代码无关，只是不同的构建脚本</p>
<h4 id="ndk-build"><a href="#ndk-build" class="headerlink" title="ndk-build"></a>ndk-build</h4><p>早期的构建使用ndk-build工具，<code>Android.mk</code> + <code>Application.mk</code> + <code>ndk-build</code></p>
<h4 id="cmake"><a href="#cmake" class="headerlink" title="cmake"></a>cmake</h4><p>默认使用CMake构建, <code>cmake</code> + <code>CMakeLists.txt</code></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  ...</span><br><span class="line">  defaultConfig &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// This block is different from the one you use to link Gradle</span></span><br><span class="line">    <span class="comment">// to your CMake build script.</span></span><br><span class="line">    externalNativeBuild &#123;</span><br><span class="line">      cmake &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// Use the following syntax when passing arguments to variables:</span></span><br><span class="line">        <span class="comment">// arguments "-DVAR_NAME=ARGUMENT".</span></span><br><span class="line">        arguments <span class="string">"-DANDROID_ARM_NEON=TRUE"</span>,</span><br><span class="line">        <span class="comment">// If you're passing multiple arguments to a variable, pass them together:</span></span><br><span class="line">        <span class="comment">// arguments "-DVAR_NAME=ARG_1 ARG_2"</span></span><br><span class="line">        <span class="comment">// The following line passes 'rtti' and 'exceptions' to 'ANDROID_CPP_FEATURES'.</span></span><br><span class="line">                  <span class="string">"-DANDROID_CPP_FEATURES=rtti exceptions"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  buildTypes &#123;...&#125;</span><br><span class="line"></span><br><span class="line">  externalNativeBuild &#123;</span><br><span class="line">  <span class="comment">// 指定CMakeList.txt路径</span></span><br><span class="line">    cmake &#123;...&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>defaultConfig</code> 里面的<code>externalNativeBuild - cmake</code> 指定<code>CMakeList.txt</code>路径</li>
<li><code>defaultConfig</code> 外面的<code>externalNativeBuild - cmake</code> 会转化成<code>CMake</code>的命令<br>更多的可以填写的命令参数和含义可以参见<a href="https://link.juejin.im/?target=https%3A%2F%2Fdeveloper.android.com%2Fndk%2Fguides%2Fcmake.html" target="_blank" rel="noopener">Android NDK-CMake文档</a></li>
</ul>
<p>CMakeLists.txt<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION <span class="number">3.4</span><span class="number">.1</span>)</span><br><span class="line"></span><br><span class="line">add_library( # Sets the name of the library.</span><br><span class="line">             gl2jni</span><br><span class="line"></span><br><span class="line">             # Sets the library as a shared library.</span><br><span class="line">             SHARED</span><br><span class="line"></span><br><span class="line">             # Provides a relative path to your source file(s).</span><br><span class="line">             src/main/cpp/gl2/gl_demo.cpp )</span><br><span class="line"></span><br><span class="line">find_library( # Sets the name of the path variable.</span><br><span class="line">              <span class="built_in">log</span>-lib</span><br><span class="line"></span><br><span class="line">              # Specifies the name of the NDK library that</span><br><span class="line">              # you want CMake to locate.</span><br><span class="line">              <span class="built_in">log</span> )</span><br><span class="line"></span><br><span class="line">target_link_libraries( # Specifies the target library.</span><br><span class="line">                       gl2jni</span><br><span class="line"></span><br><span class="line">                       # Links the target library to the <span class="built_in">log</span> library</span><br><span class="line">                       # included in the NDK.</span><br><span class="line">                       $&#123;<span class="built_in">log</span>-lib&#125; )</span><br></pre></td></tr></table></figure></p>
<h2 id="JNI"><a href="#JNI" class="headerlink" title="JNI"></a>JNI</h2><h3 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h3><p>jni中的基本数据类型可以直接与c/c++相应的基本数据类型映射，可以直接拿来使用，如下表：</p>
<table>
<thead>
<tr>
<th>Java类型</th>
<th style="text-align:center">JNI类型</th>
<th style="text-align:right">C/C++类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>Boolean</td>
<td style="text-align:center">Jblooean</td>
<td style="text-align:right">unsigned char</td>
</tr>
<tr>
<td>Byte</td>
<td style="text-align:center">Jbyte</td>
<td style="text-align:right">char</td>
</tr>
<tr>
<td>Char</td>
<td style="text-align:center">Jchar</td>
<td style="text-align:right">unsigned short</td>
</tr>
<tr>
<td>Short</td>
<td style="text-align:center">Jshort</td>
<td style="text-align:right">short</td>
</tr>
<tr>
<td>Int</td>
<td style="text-align:center">Jint</td>
<td style="text-align:right">int</td>
</tr>
<tr>
<td>Long</td>
<td style="text-align:center">Jlong</td>
<td style="text-align:right">long long</td>
</tr>
<tr>
<td>Float</td>
<td style="text-align:center">Jfloat</td>
<td style="text-align:right">float</td>
</tr>
<tr>
<td>Double</td>
<td style="text-align:center">Jdouble</td>
<td style="text-align:right">double</td>
</tr>
</tbody>
</table>
<p>与基本数据类型不同，引用类型对原生方法是不透明的，不可以直接使用</p>
<table>
<thead>
<tr>
<th>Java类型</th>
<th>JNI类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>java.lang.Class</td>
<td>jclass</td>
</tr>
<tr>
<td>java.lang.Throwable</td>
<td>jthrowable</td>
</tr>
<tr>
<td>java.lang.String</td>
<td>jstring</td>
</tr>
<tr>
<td>Object</td>
<td>jobject</td>
</tr>
<tr>
<td>boolean[]</td>
<td>jbooleanArray</td>
</tr>
<tr>
<td>byte[]</td>
<td>jbyteArray</td>
</tr>
<tr>
<td>char[]</td>
<td>jcharArray</td>
</tr>
<tr>
<td>short[]</td>
<td>jshortArray</td>
</tr>
<tr>
<td>int[]</td>
<td>jintArray</td>
</tr>
<tr>
<td>long[]</td>
<td>jlongArray</td>
</tr>
<tr>
<td>double[]</td>
<td>jdoubleArray</td>
</tr>
<tr>
<td>Other</td>
<td>jarray</td>
</tr>
</tbody>
</table>
<h3 id="对引用数据类型的操作"><a href="#对引用数据类型的操作" class="headerlink" title="对引用数据类型的操作"></a>对引用数据类型的操作</h3><p>引用类型以不透明的引用方式传递给原声代码，而不是以原声数据类型的形式呈现，因此引用类型不能直接使用和修改。JNI提供了与这些<br>引用类型密切相关的一组API，这些API可以通过JNIEnv接口指针提供给原声函数。</p>
<h4 id="字符串的操作"><a href="#字符串的操作" class="headerlink" title="字符串的操作"></a>字符串的操作</h4><ol>
<li><p>创建字符串   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jstring javaString;</span><br><span class="line">javaString = env-&gt;NewStringUTF(&quot;hello world!&quot;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>将java字符串转化成c字符串</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">EXPORT <span class="keyword">void</span> JNICALL <span class="title">com_lizy_demo_jstring2char</span><span class="params">(JNIEnv *env, jobject obj, jstring javaString)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> jbyte *str;</span><br><span class="line">    jboolean isCopy;</span><br><span class="line"></span><br><span class="line">    str = env-&gt;GetStringUTFChars(javaString, &amp;isCopy);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != str) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Java String: %s"</span>, str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (JNI_TRUE == isCopy) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"C string is a copy of the java string."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"C string points to actual string."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>释放字符串<br>通过GetStringChars和GetStringUTFChars函数获取的c字符串在原声代码中用完之后需要正确的释放，负责将会引起内存泄露。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;ReleaseStringUTFChars(javaString, str);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="数组操作"><a href="#数组操作" class="headerlink" title="数组操作"></a>数组操作</h4><ol>
<li><p>创建数组</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jnitArray javaArray;</span><br><span class="line">javaArray = env-&gt;NewIntArray(env, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> != javaArray) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>java数组复制到c数组中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jint nativeArray[<span class="number">10</span>];</span><br><span class="line">env-&gt;GetIntArrayRegion(javaArray, <span class="number">0</span>, <span class="number">10</span>, nativeArray);</span><br></pre></td></tr></table></figure>
</li>
<li><p>c数组向java数组提交所作的修改</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;SetIntArrayRegion(javaArray, <span class="number">0</span>, <span class="number">10</span>, nativeArray);</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取只想java数组元素的直接指针</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jint* nativeDirectArray;</span><br><span class="line">jboolean isCopy;</span><br><span class="line">nativeDirectArray = env-&gt;GetIntArrayElements(javaArray, &amp;isCopy);</span><br></pre></td></tr></table></figure>
</li>
<li><p>释放指向java数组元素的指针</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env-&gt;ReleaseIntArrayElements(javaArray, nativeDirectArray, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>异常处理是java程序设计语言的重要功能，JNI中的异常行为与Java中的有所不同，在Java中，<br>当抛出一个异常时，虚拟机会清除异常并将控制权交给异常处理程序。相比之下，JNI要求开发人员在异常发生后要显示的实现异常处理流。</p>
<ul>
<li><p>捕获异常<br>  JNIEnv接口提供了一组与异常相关的函数集，ExceptionOccurred查询虚拟机中是否有挂起的异常。ExceptionClear清除异常。</p>
</li>
<li><p>抛出异常 </p>
</li>
</ul>
<h3 id="C-常见异常"><a href="#C-常见异常" class="headerlink" title="C++常见异常"></a>C++常见异常</h3><ul>
<li>未初始化或初始化错误</li>
<li>访问错误<ul>
<li>数组索引访问越界</li>
<li>指针对象访问越界</li>
<li>访问空指针或无效指针对象</li>
<li>迭代器访问越界</li>
</ul>
</li>
<li>内存泄露<ul>
<li>内存未释放</li>
<li>内存局部释放</li>
</ul>
</li>
<li>参数错误<ul>
<li>本地代理、空指针、强制转换</li>
</ul>
</li>
<li>堆栈溢出<ul>
<li>递归调用</li>
<li>循环调用</li>
<li>消息循环</li>
</ul>
</li>
<li>转换错误<ul>
<li>有符号类型和无符号类型转换</li>
</ul>
</li>
</ul>
<h3 id="定位native错误"><a href="#定位native错误" class="headerlink" title="定位native错误"></a>定位native错误</h3><ul>
<li><p>addr2line</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addr2line -e libnative-lib.so 00005b13</span><br></pre></td></tr></table></figure>
</li>
<li><p>ndk-stack</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb logcat | ndk-stack -sym &lt;so文件所在目录&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="实战-使用OpenGL-ES"><a href="#实战-使用OpenGL-ES" class="headerlink" title="实战-使用OpenGL ES"></a>实战-使用OpenGL ES</h2><p>More info: (<a href="https://developer.android.com/ndk/index.html" target="_blank" rel="noopener">https://developer.android.com/ndk/index.html</a>)</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eaglelzy.github.io/2017/09/15/java/并发编程/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lizy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lizy's Wiki">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/15/java/并发编程/" itemprop="url">并发编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-15T18:46:12+08:00">
                2017-09-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/并发/" itemprop="url" rel="index">
                    <span itemprop="name">并发</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/09/15/java/并发编程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/09/15/java/并发编程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2 id="并发简介"><a href="#并发简介" class="headerlink" title="并发简介"></a>并发简介</h2><ol>
<li><p>尽管并发编程面临很多挑战，并发有一些有点使得它一直被使用：</p>
<ul>
<li>资源利用率更好</li>
<li>程序设计在某些情况下更简单</li>
<li>程序响应更快</li>
</ul>
</li>
<li><p>并发带来的风险</p>
<ul>
<li>编写并发程序会在代码上增加额外的开销。</li>
<li>正确的并发是非常复杂的，即使对于很简单的问题。</li>
<li>并发中的缺陷因为不易重现也不容易被发现。</li>
<li>并发往往需要对设计策略从根本上进行修改</li>
</ul>
</li>
</ol>
<h2 id="synchronized与Lock"><a href="#synchronized与Lock" class="headerlink" title="synchronized与Lock"></a>synchronized与Lock</h2><p>基本语法上，ReentrantLock 与 synchronized 很相似，它们都具备一样的线程重入特性，只是代码写法上有点区别而已，一个表现为 API 层面的互斥锁（Lock），一个表现为原生语法层面的互斥锁（synchronized）。ReentrantLock 相对 synchronized 而言还是增加了一些高级功能，主要有以下三项：</p>
<ul>
<li>等待可中断：当持有锁的线程长期不释放锁时，正在等待的线程可以选择放弃等待，改为处理其他事情，它对处理执行时间非常上的同步块很有帮助。而在等待由 synchronized 产生的互斥锁时，会一直阻塞，是不能被中断的。</li>
<li>可实现公平锁：多个线程在等待同一个锁时，必须按照申请锁的时间顺序排队等待，而非公平锁则不保证这点，在锁释放时，任何一个等待锁的线程都有机会获得锁。synchronized 中的锁时非公平锁，ReentrantLock 默认情况下也是非公平锁，但可以通过构造方法 ReentrantLock（ture）来要求使用公平锁。</li>
<li>锁可以绑定多个条件：ReentrantLock 对象可以同时绑定多个 Condition 对象（名曰：条件变量或条件队列），而在 synchronized 中，锁对象的 wait()和 notify()或 notifyAll()方法可以实现一个隐含条件，但如果要和多于一个的条件关联的时候，就不得不额外地添加一个锁，而 ReentrantLock 则无需这么做，只需要多次调用 newCondition()方法即可。而且我们还可以通过绑定 Condition 对象来判断当前线程通知的是哪些线程（即与 Condition 对象绑定在一起的其他线程）。</li>
</ul>
<h2 id="volitile关键字"><a href="#volitile关键字" class="headerlink" title="volitile关键字"></a>volitile关键字</h2><p>java的内存模型<br>大家都知道，计算机在执行程序时，每条指令都是在CPU中执行的，而执行指令过程中，势必涉及到数据的读取和写入。由于程序运行过程中的临时数据是存放在主存（物理内存）当中的，这时就存在一个问题，由于CPU执行速度很快，而从内存读取数据和向内存写入数据的过程跟CPU执行指令的速度比起来要慢的多，因此如果任何时候对数据的操作都要通过和内存的交互来进行，会大大降低指令执行的速度。因此在CPU里面就有了高速缓存。 也就是，当程序在运行过程中，会将运算需要的数据从主存复制一份到CPU的高速缓存当中，那么CPU进行计算时就可以直接从它的高速缓存读取数据和向其中写入数据，当运算结束之后，再将高速缓存中的数据刷新到主存当中。<br>在Java虚拟机规范中试图定义一种Java内存模型（Java Memory Model，JMM）来屏蔽各个硬件平台和操作系统的内存访问差异，以实现让Java程序在各种平台下都能达到一致的内存访问效果。Java内存模型规定所有的变量都是存在主存当中（类似于前面说的物理内存），每个线程都有自己的工作内存（类似于前面的高速缓存）。线程对变量的所有操作都必须在工作内存中进行，而不能直接对主存进行操作。并且每个线程不能访问其他线程的工作内存。</p>
<p><img src="/asserts/images/内存模型.png" alt=""></p>
<p>深入分析volitile关键字<br>一旦一个共享变量被volitile关键字修饰，那么就具备了两层含义：<br>1) 保证了不同线程对这个变量的可见行，即一个线程修改了该变量的值，其他的线程会立马可见;<br>2) 禁止指令重排序。</p>
<p>看一段代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//线程1</span></span><br><span class="line"><span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">while</span>(!stop)&#123;</span><br><span class="line">    doSomething();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//线程2</span></span><br><span class="line">stop = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure></p>
<p>很多人用这样的代码来控制线程的退出，大多数时候是没有问题的，但是也有可能会出现线程1退不出的问题.<br>每个线程在运行过程中都有自己的工作内存，那么线程1在运行的时候，会将stop变量的值拷贝一份放在自己的工作内存当中。那么当线程2更改了stop变量的值之后，但是还没来得及写入主存当中，线程2转去做其他事情了，那么线程1由于不知道线程2对stop变量的更改，因此还会一直循环下去。<br>但是用volatile修饰之后就变得不一样了：</p>
<ol>
<li>使用volatile关键字会强制将修改的值立即写入主存；</li>
<li>使用volatile关键字的话，当线程2进行修改时，会导致线程1的工作内存中缓存变量stop的缓存行无效（反映到硬件层的话，就是CPU的L1或者L2缓存中对应的缓存行无效）；</li>
<li>由于线程1的工作内存中缓存变量stop的缓存行无效，所以线程1再次读取变量stop的值时会去主存读取。</li>
</ol>
<p>所以线程1读取到的就是最新的正确的值。</p>
<p>ConcurrentHashMap分析<br>java中的HashMap是线程不安全的，在多线程环境下会存在扩容时死循环导致cpu占用100%的问题, 因此在并发环境下不应该使用HashMap，而应该使用ConcurrentHashMap。 相比HashMap来说ConcurrentHashMap不仅是线程安全的，而且在效率上有了很大的提升。 </p>
<ul>
<li>针对Segment加锁，而不是对整个map加锁，大大提高了并发的效率;</li>
<li>使用final不可变来保证put，remove等操作不会对get操作产生影响.</li>
<li>使用volitile关键字保证put之后再调用get获取的肯定是最新值。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> count;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">V <span class="title">get</span><span class="params">(Object key, <span class="keyword">int</span> hash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count != <span class="number">0</span>) &#123; <span class="comment">// read-volatile</span></span><br><span class="line">        HashEntry&lt;K,V&gt; e = getFirst(hash);</span><br><span class="line">        <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp; key.equals(e.key)) &#123;</span><br><span class="line">                V v = e.value;</span><br><span class="line">                <span class="keyword">if</span> (v != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> v;</span><br><span class="line">                <span class="keyword">return</span> readValueUnderLock(e); <span class="comment">// recheck</span></span><br><span class="line">            &#125;</span><br><span class="line">            e = e.next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">V <span class="title">put</span><span class="params">(K key, <span class="keyword">int</span> hash, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> c = count;</span><br><span class="line">        <span class="keyword">if</span> (c++ &gt; threshold) <span class="comment">// ensure capacity</span></span><br><span class="line">            rehash();</span><br><span class="line">        HashEntry&lt;K,V&gt;[] tab = table;</span><br><span class="line">        <span class="keyword">int</span> index = hash &amp; (tab.length - <span class="number">1</span>);</span><br><span class="line">        HashEntry&lt;K,V&gt; first = tab[index];</span><br><span class="line">        HashEntry&lt;K,V&gt; e = first;</span><br><span class="line">        <span class="keyword">while</span> (e != <span class="keyword">null</span> &amp;&amp; (e.hash != hash || !key.equals(e.key)))</span><br><span class="line">            e = e.next;</span><br><span class="line">  </span><br><span class="line">        V oldValue;</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                e.value = value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            oldValue = <span class="keyword">null</span>;</span><br><span class="line">            ++modCount;</span><br><span class="line">            tab[index] = <span class="keyword">new</span> HashEntry&lt;K,V&gt;(key, hash, first, value);</span><br><span class="line">            count = c; <span class="comment">// write-volatile</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> oldValue;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到count是volatile的，实际上这里里面利用了volatile的语义：<br>对volatile字段的写入操作happens-before于每一个后续的同一个字段的读操作。实际上put、remove等操作也会更新count的值，所以当竞争发生的时候，volatile的语义可以保证写操作在读操作之前，也就保证了写操作对后续的读操作都是可见的，这样后面get的后续操作就可以拿到完整的元素内容。</p>
<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p>合理利用线程池可以带来三个好处：</p>
<ul>
<li>降低资源消耗</li>
<li>提高响应速度</li>
<li>提高线程可管理性</li>
</ul>
<p>可以通过ThreadPoolExecutor来创建一个线程池：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ThreadPoolExecutor(corePoolSize, maximumPoolSize, keepAliveTime, milliseconds,runnableTaskQueue, handler);</span><br></pre></td></tr></table></figure></p>
<ul>
<li>corePoolSize（线程池的基本大小）：当提交一个任务到线程池时，线程池会创建一个线程来执行任务，即使其他空闲的基本线程能够执行新任务也会创建线程，等到需要执行的任务数大于线程池基本大小时就不再创建。如果调用了线程池的prestartAllCoreThreads方法，线程池会提前创建并启动所有基本线程。</li>
<li>maximumPoolSize（线程池最大大小）：线程池允许创建的最大线程数。如果队列满了，并且已创建的线程数小于最大线程数，则线程池会再创建新的线程执行任务。值得注意的是如果使用了无界的任务队列这个参数就没什么效果。</li>
<li>keepAliveTime（线程活动保持时间）：线程池的工作线程空闲后，保持存活的时间。所以如果任务很多，并且每个任务执行的时间比较短，可以调大这个时间，提高线程的利用率。</li>
<li>TimeUnit（线程活动保持时间的单位）：可选的单位有天（DAYS），小时（HOURS），分钟（MINUTES），毫秒(MILLISECONDS)，微秒(MICROSECONDS, 千分之一毫秒)和毫微秒(NANOSECONDS, 千分之一微秒)。</li>
<li>ThreadFactory：用于设置创建线程的工厂，可以通过线程工厂给每个创建出来的线程设置更有意义的名字。</li>
<li>runnableTaskQueue（任务队列）：用于保存等待执行的任务的阻塞队列。 可以选择以下几个阻塞队列。<ul>
<li>ArrayBlockingQueue：是一个基于数组结构的有界阻塞队列，此队列按 FIFO（先进先出）原则对元素进行排序。</li>
<li>LinkedBlockingQueue：一个基于链表结构的阻塞队列，此队列按FIFO （先进先出） 排序元素，吞吐量通常要高于ArrayBlockingQueue。静态工厂方法Executors.newFixedThreadPool()使用了这个队列。</li>
<li>SynchronousQueue：一个不存储元素的阻塞队列。每个插入操作必须等到另一个线程调用移除操作，否则插入操作一直处于阻塞状态，吞吐量通常要高于LinkedBlockingQueue，静态工厂方法Executors.newCachedThreadPool使用了这个队列。</li>
<li>PriorityBlockingQueue：一个具有优先级的无限阻塞队列。</li>
</ul>
</li>
<li>RejectedExecutionHandler（饱和策略）：当队列和线程池都满了，说明线程池处于饱和状态，那么必须采取一种策略处理提交的新任务。这个策略默认情况下是AbortPolicy，表示无法处理新任务时抛出异常。以下是JDK1.5提供的四种策略。<ul>
<li>AbortPolicy：直接抛出异常。</li>
<li>CallerRunsPolicy：只用调用者所在线程来运行任务。</li>
<li>DiscardOldestPolicy：丢弃队列里最近的一个任务，并执行当前任务。</li>
<li>DiscardPolicy：不处理，丢弃掉。</li>
<li>当然也可以根据应用场景需要来实现RejectedExecutionHandler接口自定义策略。如记录日志或持久化不能处理的任务。</li>
</ul>
</li>
</ul>
<p>AsyncTask 代码解析</p>
<h2 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h2><p>并发工具类中提供了一些并发流程控制的手段，主要有CountDownLatch，CyclicBarriery和Semaphore</p>
<ul>
<li>CountDownLatch能够使一个线程等待，等待其他线程完成各自任务后再执行当前线程工作。</li>
<li>CyclicBarrier可以实现一组线程等待至某个状态后再同时执行。而且可复用</li>
<li>Semaphore信号量，可以控制多个线程访问有限资源，通过acquire()获取一个许可，如果没有就等待，通过release释放一个许可。</li>
</ul>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><ol>
<li>生产者消费者</li>
<li>ThreadLocal和Looper</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eaglelzy.github.io/2017/01/07/examples/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lizy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lizy's Wiki">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/07/examples/" itemprop="url">examples</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-07T20:41:33+08:00">
                2017-01-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/随笔/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/07/examples/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/07/examples/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <h2 id="分割线"><a href="#分割线" class="headerlink" title="分割线"></a>分割线</h2><hr>
<hr>
<h2 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h2><ul>
<li>文本1</li>
<li>文本2</li>
<li>文本3</li>
</ul>
<ul>
<li><p>Lorem ipsum dolor sit amet, consectetuer adipiscing elit.<br>Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,<br>viverra nec, fringilla in, laoreet vitae, risus.</p>
<p>Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,<br>viverra nec, fringilla in, laoreet vitae, risus.</p>
</li>
<li><p>Donec sit amet nisl. Aliquam semper ipsum sit amet velit.<br>Suspendisse id sem consectetuer libero luctus adipiscing.</p>
</li>
</ul>
<ol>
<li>Bird</li>
<li>Magic</li>
<li>Dog</li>
</ol>
<h2 id="链接和图片"><a href="#链接和图片" class="headerlink" title="链接和图片"></a>链接和图片</h2><p><a href="http://www.jianshu.com" target="_blank" rel="noopener">简书</a></p>
<p>自动链接<br><a href="https://eaglelzy.github.io">https://eaglelzy.github.io</a></p>
<p>我经常去的几个网站<a href="http://www.google.com" target="_blank" rel="noopener">Google</a>,<a href="https://yuhongjun.github.io/" title="Demi的随笔和技术空间" target="_blank" rel="noopener">Demi的随笔和技术空间</a>,<a href="https://yuhongjun.github.io/" target="_blank" rel="noopener">Demi的随笔和技术空间</a>。</p>
<p><img src="http://ww4.sinaimg.cn/bmiddle/aa397b7fjw1dzplsgpdw5j.jpg" alt=""></p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><blockquote>
<p>一盏灯， 一片昏黄； 一简书， 一杯淡茶。 守着那一份淡定， 品读属于自己的寂寞。 保持淡定， 才能欣赏到最美丽的风景！ 保持淡定， 人生从此不再寂寞。</p>
</blockquote>
<blockquote>
<p>一盏灯， 一片昏黄； 一简书， 一杯淡茶。 </p>
<blockquote>
<p>嵌套引用：守着那一份淡定， 品读属于自己的寂寞。 保持淡定， 才能欣赏到最美丽的风景！ 保持淡定， 人生从此不再寂寞。</p>
</blockquote>
</blockquote>
<blockquote>
<h2 id="这是个标题"><a href="#这是个标题" class="headerlink" title="这是个标题"></a>这是个标题</h2><ol>
<li>第一行</li>
<li>第二行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> return shell_exec("echo")</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
</blockquote>
<h3 id="引用书上的句子"><a href="#引用书上的句子" class="headerlink" title="引用书上的句子"></a>引用书上的句子</h3><blockquote><p>Do not just seek happiness for yourself. Seek happiness for all. Through kindness. Through mercy.</p>
<footer><strong>David Levithan</strong><cite>Wide Awake</cite></footer></blockquote>
<h3 id="引用Twitter"><a href="#引用Twitter" class="headerlink" title="引用Twitter"></a>引用Twitter</h3><blockquote><p>NEW: DevDocs now comes with syntax highlighting. <a href="http://devdocs.io" target="_blank" rel="noopener">http://devdocs.io</a></p>
<footer><strong>@DevDocs</strong><cite><a href="https://twitter.com/devdocs/status/356095192085962752" target="_blank" rel="noopener">twitter.com/devdocs/status/356095192085962752</a></cite></footer></blockquote>
<h3 id="引用网络上的文章"><a href="#引用网络上的文章" class="headerlink" title="引用网络上的文章"></a>引用网络上的文章</h3><blockquote><p>Every interaction is both precious and an opportunity to delight.</p>
<footer><strong>Seth Godin</strong><cite><a href="http://sethgodin.typepad.com/seths_blog/2009/07/welcome-to-island-marketing.html" target="_blank" rel="noopener">Welcome to Island Marketing</a></cite></footer></blockquote>
<h2 id="粗体和斜体"><a href="#粗体和斜体" class="headerlink" title="粗体和斜体"></a>粗体和斜体</h2><p><em>一盏灯</em>， 一片昏黄；<strong>一简书</strong>， 一杯淡茶。 守着那一份淡定， 品读属于自己的寂寞。 保持淡定， 才能欣赏到最美丽的风景！ 保持淡定， 人生从此不再寂寞。</p>
<h2 id="代码和引用"><a href="#代码和引用" class="headerlink" title="代码和引用"></a>代码和引用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> sudo pacman -Syu</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>main.java</span><a href="http://www.baidu.com" target="_blank" rel="noopener">more</a></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"hello world!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote class="pullquote [class]"><p>content</p>
</blockquote>
<div class="video-container"><iframe src="//www.youtube.com/embed/video_id" frameborder="0" allowfullscreen></iframe></div>
<h2 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h2><table>
<thead>
<tr>
<th>Tables</th>
<th style="text-align:center">Are</th>
<th style="text-align:right">Cool</th>
</tr>
</thead>
<tbody>
<tr>
<td>col 3 is</td>
<td style="text-align:center">right-aligned</td>
<td style="text-align:right">$1600</td>
</tr>
<tr>
<td>col 2 is</td>
<td style="text-align:center">centered</td>
<td style="text-align:right">$12</td>
</tr>
<tr>
<td>zebra stripes</td>
<td style="text-align:center">are neat</td>
<td style="text-align:right">$1</td>
</tr>
</tbody>
</table>
<figure class="highlight graph"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    A--&gt;B;</span><br><span class="line">    A--&gt;C;</span><br><span class="line">    B--&gt;D;</span><br><span class="line">    C--&gt;E;</span><br><span class="line">    E--&gt;F;</span><br><span class="line">    D--&gt;F;</span><br><span class="line">    F--&gt;G;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://eaglelzy.github.io/2017/01/07/随笔/配置Vim支持Hexo/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lizy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lizy's Wiki">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/07/随笔/配置Vim支持Hexo/" itemprop="url">配置Vim支持Hexo</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-07T13:22:59+08:00">
                2017-01-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/hexo/" itemprop="url" rel="index">
                    <span itemprop="name">hexo</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/01/07/随笔/配置Vim支持Hexo/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/01/07/随笔/配置Vim支持Hexo/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        
          
            <p>Hexo 是一个快速、简洁且高效的博客框架。vim又是一款优秀的编辑器，如果能把Hexo和vim结合起来就非常酷啦。<br>为了把两者结合起来我写了一个很简单的一个插件<a href="https://github.com/eaglelzy/vim-hexo" target="_blank" rel="noopener">vim-hexo</a>。 按照说明安装完插件后，就可以使用了.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Lizy">
            
              <p class="site-author-name" itemprop="name">Lizy</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">版权所有 Lizy</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"eaglelzy"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  


















  





  

  

  

  
  

  

  

  

</body>
</html>
